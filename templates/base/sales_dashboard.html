{% extends 'sales_base.html' %}
{% load static %}
{% block content %}
<style>
  .mention-textarea {
    font-family: 'Arial';
    color: rgb(20, 95, 245);
    font-weight: bold;
  }

   #priceTable_wrapper {
    border: 1px solid #d1d1d1;
    overflow-x: auto;
    margin-top: 20px;
    width: 100%; /* Adjust as needed */
  }

  #priceTable th,
  #priceTable td {
    border: 1px solid #d1d1d1;
    padding: 10px;
  }

  .table-container {
  max-height: 400px; /* Set the maximum height of the container */
  overflow-y: auto; /* Enable vertical scroll if content overflows */
  border: 1px solid #dee2e6;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: auto;
  height: inherit;
  width: 100%; /* Take up full width */
  padding: 0; /* Remove any padding */
  margin: 0;
  
  
}

.elegant-table {
  border-collapse: collapse;
  width: 100%;
}

.elegant-table th,
.elegant-table td {
  border: 1px solid #dee2e6;
  padding: 8px;
  text-align: center;
}

.elegant-table th {
  background-color: #343a40;
  color: white;
}

.week-navigation {
  display: flex;
  gap: 10px;
}

.week-button {
  font-size: 14px;
  padding: 6px 12px;
}

.price-table-card {
  border: none;
  border-radius: 15px;
  box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.1);
}

#priceTable {
  width: 100%; /* Set the table to auto width to allow it to stretch */
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

.greeting {
  animation: fadeIn 1s ease-in-out;
}
.main-content {
  animation: fadeIn 1s ease-in-out;
}

</style>


<main role="main" class="main-content">
  <div class="container-fluid">
    <div class="row justify-content-center">
       
      <div class="col-12">
        <h1>Hello ✌ {{ user.first_name }}</h1>
        <div class="row">
          <div class="col-md-6 col-xl-3 mb-4">
            <div class="card shadow bg-primary text-white border-0">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3 text-center">
                    <span class="circle circle-sm bg-primary-light">
                      <i class="fe fe-16 fe-shopping-bag text-white mb-0"></i>
                    </span>
                  </div>

                  <div class="col pr-0">
                    <p class="small text-muted mb-0">Number of leads assigned</p>
                    <span class="h3 mb-0 text-white">{{ assigned_leads_count }}</span>
                    <!-- Add other relevant styling and content -->
                  </div>

                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-xl-3 mb-4">
            <div class="card shadow border-0">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3 text-center">
                    <span class="circle circle-sm bg-primary">
                      <i class="fe fe-16 fe-shopping-cart text-white mb-0"></i>
                    </span>
                  </div>
                  <div class="col pr-0">
                    <p class="small text-muted mb-0">Number of Signé CPF</p>
                    {% if not request.user.is_superuser %}
                    <span class="h3 mb-0">{{ signe_cpf_leads_count }}</span>

                    {% else %}
                    <span class="h3 mb-0">-</span> {# Show a dash for superusers #}
                    {% endif %}
                  </div>

                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-xl-3 mb-4">
            <div class="card shadow border-0">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3 text-center">
                    <span class="circle circle-sm bg-primary">
                      <i class="fe fe-16 fe-filter text-white mb-0"></i>
                    </span>
                  </div>
                  <div class="col">
                    <p class="small text-muted mb-0">Conversion</p>
                    <div class="row align-items-center no-gutters">
                      <div class="col-auto">
                        <span class="h3 mr-2 mb-0">{{ conversion_rate|floatformat:1 }}%</span>
                      </div>
                      <div class="col-md-12 col-lg">
                        <div class="progress progress-sm mt-2" style="height:3px">
                          <div class="progress-bar bg-success" role="progressbar" style="width: {{ conversion_rate }}%"
                            aria-valuenow="{{ conversion_rate }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-xl-3 mb-4">
            <div class="card shadow border-0">
              <div class="card-body">
                <div class="row align-items-center">
                  <div class="col-3 text-center">
                    <span class="circle circle-sm bg-primary">
                      <i class="fe fe-16 fe-activity text-white mb-0"></i>
                    </span>
                  </div>
                  <div class="col">
                    <p class="small text-muted mb-0">AVG Orders</p>
                    <span class="h3 mb-0">$80</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div> <!-- end section -->
            <div class="row">
  <!-- Price Table Section -->
  <div class="col-md-12">
    <div class="card shadow price-table-card">
      <div class="card-body d-flex flex-column align-items-center">
        <div class="d-flex justify-content-between align-items-center mb-3 w-100">
          <div>
            <button type="button" class="btn btn-secondary week-button" id="prevWeek">Previous Week</button>
          
            <button type="button" class="btn btn-secondary week-button" id="nextWeek">Next Week</button>
          </div>
          
          <h4 class="text-center">Price Table</h4>
          <div>
            <button type="button" class="btn btn-secondary week-button" id="presentWeek">Present Week</button>
          </div>
        </div>
        <h6 id="table-heading" class="text-center mb-3"></h6>
        <div class="table-container">
          <div id="priceTable_wrapper" class="table-responsive">
            <table id="priceTable" class="table table-striped table-bordered elegant-table">
              <thead class="thead-dark">
                <tr role="row">
                  <th>User</th>
                  <th>Monday</th>
                  <th>Tuesday</th>
                  <th>Wednesday</th>
                  <th>Thursday</th>
                  <th>Friday</th>
                  <th>Saturday</th>
                  <th>Sunday</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div> <!-- .col-md-12 -->
</div>


</main> <!-- main -->
</div> <!-- .wrapper -->
{% endblock %}
{% block javascript %}
<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.3.1/css/select.bootstrap.css" />
<script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
<script>
  var selectedWeek = 0; // Initialize the selected week offset

  function updateTable(data) {
    var tableBody = $('#priceTable tbody');
    tableBody.empty();

    var weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    $.each(data, function(userId, userData) {
      var row = $('<tr></tr>');
      row.append($('<td></td>').text(userData.username));

      for (var i = 0; i < weekdays.length; i++) {
        var day = weekdays[i];
        var price = userData.prices[day] || '0';
        var roundedPrice = parseFloat(price).toFixed(2);
        row.append($('<td></td>').text(roundedPrice));
      }

      tableBody.append(row);
    });
  }

  function fetchAndPopulateData(weekOffset) {
    selectedWeek += weekOffset;

    $.ajax({
      url: '{% url "fetch_price_data" %}',
      method: 'GET',
      data: { week_offset: selectedWeek },
      dataType: 'json',
      success: function(data) {
        updateTable(data);
        updateHeading(selectedWeek);
      },
      error: function() {
        console.error('Failed to fetch price data.');
      }
    });
  }

  function updateHeading(weekOffset) {
    var today = new Date();
    var startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - (today.getDay() + 7 * weekOffset));
    var endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 6);

    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    var month = monthNames[startDate.getMonth()];
    var week = weekOffset === 0 ? 'Present Week' : 'Week ' + (weekOffset > 0 ? weekOffset : 'Previous');

    $('#table-heading').text(month + ' | ' + week + ' (' + startDate.toDateString() + ' - ' + endDate.toDateString() + ')');
  }

  $(document).ready(function() {
    fetchAndPopulateData(0);

    $('#prevWeek').click(function() {
      fetchAndPopulateData(1);
    });

     $('#nextWeek').click(function() {
    fetchAndPopulateData(-1);
  });
  
    $('#presentWeek').click(function() {
      selectedWeek = 0;
      fetchAndPopulateData(0);
    });
  });
</script>
{% endblock %}